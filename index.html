<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <!--

github.com/lafelabs/OSHI/README.md

    -->

<link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEREREREREREREREREREREREREREREREREREREREREREQAQABEQERAQEQEQERAREBAQEBARABEQEBEQEBAQAAAQERAQARAREBAREBAREBEQEQABEBEQAAEREREREREREREREREREREREREREREREREREREREREREREREREREREREAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" rel="icon" type="image/x-icon">


    <!--Stop Google:-->
    <META NAME="robots" CONTENT="noindex,nofollow">
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/p5.js" defer></script>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script>
            MathJax.Hub.Config({
                tex2jax: {
                inlineMath: [['$','$'], ['\\(','\\)']],
                processEscapes: true,
                processClass: "mathjax",
                ignoreClass: "no-mathjax"
                }
            });//			MathJax.Hub.Typeset();//tell Mathjax to update the math
        </script>

    
</head>
<body>    

<div id = "sidepanel">
<p>
<a id = "editlink" href= "webeditor.html">EDIT</a>
</p>
<table>
        <tr>
            <td>NOTES:</td>
            <TD>
                <INPUT id = "notesinput"/>
            </TD>
        </tr>
    </table>

    <textarea id ="jsonio"></textarea>
    <div id = "savebutton" class = "button">SAVE</div>

    <div id = "plotscroll">
            <!--this is where the plots go-->
    </div>

</div>

<script>

if(innerWidth - innerHeight){
    document.getElementById("sidepanel").style.width = (innerWidth - 800).toString() + "px";
}

var httpc = new XMLHttpRequest();
httpc.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        jsondata = JSON.parse(this.responseText);            
        document.getElementById("jsonio").value = this.responseText;
    }
};
httpc.open("GET", "fileloader.php?filename=testdata.txt", true);
httpc.send();

notes = "";
var httpcnotes = new XMLHttpRequest();
httpcnotes.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        notes = this.responseText;            
        document.getElementById("notesinput").value = notes;
    }
};
httpcnotes.open("GET", "fileloader.php?filename=notes.txt", true);
httpcnotes.send();


ticlength = 15;//pixels
xticunit = 1e9;//1 GHz
yticunit = 10;//10 dB
textfontsize = 24;
graphmargin = 50;
    
function setup() {

  createCanvas(800, 600);    
  strokeWeight(2);  
  background(255);
  noFill();
  stroke(0);
  strokeWeight(4);

}


function draw(){

  frameRate(12);
  var httpc = new XMLHttpRequest();
    httpc.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            jsondata = JSON.parse(this.responseText);
            jsondata.notes = notes;
              background(255);
              noFill();
              strokeWeight(5);
              beginShape();
              for (var i = 0; i < jsondata.frequency.length; i++){
                var x = graphmargin + map(i,0,jsondata.frequency.length, 0, width - 2*graphmargin);
                var y = graphmargin + map(-jsondata.S21_logmag[i], -40, 0,2*graphmargin -height, 0);
                vertex(x, y);
              }
              endShape();
              
              rect(graphmargin,graphmargin,width - 2*graphmargin,height - 2*graphmargin);

              
              
              for(var index = 1;index < 15;index++){
                  ticx = graphmargin + map(1e9*index,jsondata.f_start,jsondata.f_stop, 0, width - 2*graphmargin);
                  strokeWeight(1);
                  textSize(18);
                  fill(0);
                  text(index.toString(),ticx - 5,height - graphmargin + 20);
                  line(ticx,graphmargin,ticx,height- graphmargin);          
                  strokeWeight(5);
                  line(ticx,height- graphmargin - 10,ticx,height- graphmargin);    
                  line(ticx,graphmargin + 10,ticx,graphmargin);    

              }

              for(var index = 1;index < 8;index++){
                 
                  ticy = graphmargin + map(10*index, -40, 0,2*graphmargin - height, 0);
                  strokeWeight(1);
                  textSize(18);
                  fill(0);
                  text((-index*10).toString(),graphmargin - 36,ticy + 6);

                  line(graphmargin,ticy,width - graphmargin,ticy);          
                  strokeWeight(5);
                  line(graphmargin,ticy,graphmargin+ 10,ticy);    
                  line(width - graphmargin,ticy,width - graphmargin - 10,ticy);    
              }
              fill(0);
                  strokeWeight(1);
              text("Frequency [GHz]",0.5*width - 100,height - graphmargin + 40);
        
              text("0",graphmargin - 18,graphmargin+6);
              text(jsondata.notes,graphmargin - 18,33);

    
              rotate(Math.PI/2);
              translate(width/2 - 300,-height/2 - 25);
              text("S21 [dB]",100,0.5*height);
              translate(-width/2 + 300,height/2 + 25);
              rotate(-Math.PI/2);
              
        }
    };
    httpc.open("GET", "fileloader.php?filename=testdata.txt", true);
    httpc.send();



}



function post(){
            
    png64 = document.getElementById("defaultCanvas0").toDataURL("image/png");
    var timestamp = Math.round((new Date().getTime())/1000).toString();
    var httpc = new XMLHttpRequest();
    var url = "pngsave.php";        
    httpc.open("POST", url, true);
    httpc.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    httpc.send("data="+encodeURIComponent(png64.substring(22))+"&filename=plots/vnaplot" + timestamp +  ".png");//send text to filesaver.php
     //location.reload(); 
     
    newfilename = "plots/vnaplot" + timestamp +  ".png";
    
    var newbox = document.createElement("DIV");
    newbox.classList.add("imagebox");         
    
    var deletespan = document.createElement("SPAN");
    deletespan.innerHTML = "X";
    deletespan.classList.add("deletespan");
    deletespan.onclick = function(){
        //delete the parent div of the image
        //delete the file
        var filename = this.parentElement.getElementsByClassName("filelabel")[0].innerHTML; 
        var httpc = new XMLHttpRequest();
        var url = "deletefile.php";         
        httpc.open("POST", url, true);
        httpc.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=utf-8");
        httpc.send("filename=plots/" + filename);//send text to deletefile.php
        this.parentElement.parentElement.removeChild(this.parentElement);
    }
    
    newbox.appendChild(deletespan);

    var newdiv = document.createElement("DIV");
    newdiv.innerHTML = newfilename;
    newdiv.className = "filelabel";
    newbox.appendChild(newdiv);

    var newimg = document.createElement("IMG");
    newimg.src = png64;
    newimg.classList.add("uploadimage");
    newimg.classList.add("button");
    newbox.appendChild(newimg);    


    document.getElementById("plotscroll").insertBefore(newbox,document.getElementById("plotscroll").getElementsByClassName("imagebox")[0]);
        
}

function keyPressed() {

    if(key == 's'){
        post();
    }

}


document.getElementById("savebutton").onclick = function(){
    post();
}

upuploadImages = [];
var httpc9 = new XMLHttpRequest();
    httpc9.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        upuploadImages = JSON.parse(this.responseText);
        for(var index = upuploadImages.length - 1;index >= 0;index--) {
            
            if(upuploadImages[index].includes("vnaplot")){
            
                var newbox = document.createElement("DIV");
                newbox.classList.add("imagebox");         
                
                var deletespan = document.createElement("SPAN");
                deletespan.innerHTML = "X";
                deletespan.classList.add("deletespan");
                deletespan.onclick = function(){
                    //delete the parent div of the image
                    //delete the file
                    var filename = this.parentElement.getElementsByClassName("filelabel")[0].innerHTML; 
                    var httpc = new XMLHttpRequest();
                    var url = "deletefile.php";         
                    httpc.open("POST", url, true);
                    httpc.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=utf-8");
                    httpc.send("filename=plots/" + filename);//send text to deletefile.php
                    this.parentElement.parentElement.removeChild(this.parentElement);
                }
                
                newbox.appendChild(deletespan);
        
                var newdiv = document.createElement("DIV");
                newdiv.innerHTML = upuploadImages[index];
                newdiv.className = "filelabel";
                newbox.appendChild(newdiv);
            
                
                document.getElementById("plotscroll").appendChild(newbox);
                var newimg = document.createElement("IMG");
                newimg.src = "plots/" + upuploadImages[index];
                newimg.classList.add("uploadimage");
                newimg.classList.add("button");
                newbox.appendChild(newimg);
                
            }
            
        }
    }
};
httpc9.open("GET", "dir.php?filename=plots", true);
httpc9.send();

</script>
<style>
body{
    overflow:hidden;
    background-color:white;
    font-family:Arial;
}
a{
    color:blue;
}
#jsonio{
    width:80%;
    height:10em;
}
#plotscroll{
    width:100%;
    overflow:scroll;
    bottom:0px;
}
#plotscroll img{
    max-width:50%;
}
#defaultCanvas0{
    border:solid;
    position:absolute;
    right:5px;
    top:5px;
    
}
#main{
    position:absolute;
    right:0px;
    top:0px;
}
@media only screen and (orientation: landscape) {

    
}

@media only screen and (orientation: portrait) {
    
    
}

.deletespan{
    color:red;
    border:solid;
    border-color:red;
    border-radius:0.5em;
    padding: 1em 1em 1em 1em;
    cursor:pointer;
}
.deletespan:hover{
    background-color:#ff000080;
}

.filelabel{
    display:none;
}
.button{
    cursor:pointer;
}
.button:hover{
    background-color:green;
}
.button:active{
    background-color:yellow;
}
.data{
    display:none;
}
#savebutton{
    text-align:center;
    border:solid;
    border-radius:10px;
    border-width:4px;
    font-family:Comic Sans MS;
    font-size:1.5em;
    width:5em;
    margin:auto;
    cursor:pointer;
}
#savebutton:hover{
    background-color:green;
}
#savebutton:active{
    background-color:yellow;
}
</style>
</body>
</html>